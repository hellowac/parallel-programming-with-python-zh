
<!DOCTYPE html>

<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../dispatching_a_simple_task/" rel="prev"/>
<link href="../defining_queues_by_task_types/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.2, mkdocs-material-9.0.13" name="generator"/>
<title>使用 Celery 获取斐波那契数列项 - python并发编程-中文版</title>
<link href="../../assets/stylesheets/main.ffa9267a.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.a0c5b2b5.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                .gdesc-inner { font-size: 0.75rem; }
                body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
                body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
                body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
                </style><script src="../../assets/javascripts/glightbox.min.js"></script></head>
<body data-md-color-accent="red" data-md-color-primary="default" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#celery">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="python并发编程-中文版" class="md-header__button md-logo" data-md-component="logo" href="../.." title="python并发编程-中文版">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            python并发编程-中文版
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              使用 Celery 获取斐波那契数列项
            
          </span>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜索" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜索" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="查找" class="md-search__options">
<button aria-label="清空当前内容" class="md-search__icon md-icon" tabindex="-1" title="清空当前内容" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/hellowac/parallel-programming-with-python-zh/tree/docs" title="前往仓库">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    hellowac/parallel-programming-with-python-zh
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="python并发编程-中文版" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="python并发编程-中文版">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    python并发编程-中文版
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/hellowac/parallel-programming-with-python-zh/tree/docs" title="前往仓库">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    hellowac/parallel-programming-with-python-zh
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
        python并发编程
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../chapter1/">第一章 并行、并发以及分布式编程的对比分析</a>
<label for="__nav_2">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          第一章 并行、并发以及分布式编程的对比分析
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter1/why_use_parallel_programming/">
        为什么使用并行编程
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter1/exploring_common_forms_of_parallelization/">
        探索并行化的几种方式
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter1/communicating_in_parallel_programming/">
        并行编程间的通信
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter1/identifying_parallel_programming_problems/">
        识别并行编程的问题
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter1/discovering_Pythons_parallel_programming_tools/">
        发现Python并行编程的工具
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter1/taking_care_of_GIL/">
        小心PythonGIL
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter1/summary/">
        小结
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../chapter2/">第二章 设计并行算法</a>
<label for="__nav_3">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
          第二章 设计并行算法
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter2/%E5%88%86%E6%B2%BB%E6%8A%80%E6%9C%AF/">
        分治技术
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter2/%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%88%86%E8%A7%A3/">
        使用数据分解
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter2/%E7%94%A8%E7%AE%A1%E9%81%93%E5%88%86%E8%A7%A3%E4%BB%BB%E5%8A%A1/">
        用管道分解任务
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter2/%E5%A4%84%E7%90%86%E5%92%8C%E6%98%A0%E5%B0%84/">
        处理和映射
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter2/%E6%80%BB%E7%BB%93/">
        小结
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../chapter3/">第三章 设计并行算法</a>
<label for="__nav_4">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
          第三章 设计并行算法
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter3/%E4%BB%8E%E5%A4%9A%E4%B8%AA%E8%BE%93%E5%85%A5%E4%B8%AD%E5%BE%97%E5%88%B0%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%9C%80%E5%A4%A7%E7%9A%84%E5%80%BC/">
        从多个输入中得到斐波那契最大的值
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter3/%E7%88%AC%E5%8F%96%E7%BD%91%E9%A1%B5/">
        爬取网页
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter3/%E6%80%BB%E7%BB%93/">
        小结
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../chapter4/">第四章 使用threading和concurrent.futures模块</a>
<label for="__nav_5">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
          第四章 使用threading和concurrent.futures模块
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter4/defining_threads/">
        什么是线程
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter4/using_threading_to_obtain_the_Fibonacci_series_term_with_multiple_inputs/">
        使用threading模块来为多个输入同时计算Fibonacci序列
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter4/crawling_the_web_using_the_concurrent_futures_module/">
        使用concurrent.futures模块爬取web信息
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter4/%E6%80%BB%E7%BB%93/">
        小结
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_6" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../chapter5/">第五章 使用多进程和进程池</a>
<label for="__nav_6">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
          第五章 使用多进程和进程池
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter5/understanding_the_concept_of_a_process/">
        理解进程的概念
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter5/implementing_multiprocessing_communication/">
        理解多进程通信
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter5/using_multiprocessing_to_compute_fibonacci_series_terms_with_multiple_inputs/">
        使用多进程解决斐波那契数列多输入问题
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter5/crawling_the_web_using_processPoolExecutor/">
        使用ProcessPoolExecutor模块设计网络爬虫
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter5/%E6%80%BB%E7%BB%93/">
        小结
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_7" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../chapter6/">第六章 使用并行 Python</a>
<label for="__nav_7">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_7_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
          第六章 使用并行 Python
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter6/understanding_interprocess_communication/">
        理解进程间通信
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter6/discovering_pp/">
        了解Parallel Python(PP)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter6/using_pp_to_calculate_the_fibonacci_series_term_on_smp_architecture/">
        在SMP架构上使用PP计算斐波那契序列
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter6/using_pp_to_make_a_distributed_web_crawler/">
        使用PP创建分布式的网络爬虫
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter6/%E6%80%BB%E7%BB%93/">
        小结
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_8" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../">第七章 使用Celery分发任务</a>
<label for="__nav_8">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_8_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_8">
<span class="md-nav__icon md-icon"></span>
          第七章 使用Celery分发任务
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../understanding_celery/">
        理解 Celery
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../understanding_celery_architecture/">
        理解 Celery 的架构
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../setting_up_the_environment/">
        搭建环境
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../dispatching_a_simple_task/">
        分派一个简单的任务
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          使用 Celery 获取斐波那契数列项
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        使用 Celery 获取斐波那契数列项
      </a>
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目录
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_1">
    完整示例
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../defining_queues_by_task_types/">
        根据任务类型定义队列
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../using_celery_to_make_a_distributed_web_crawler/">
        使用 Celery 制作分布式网络爬虫
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../%E6%80%BB%E7%BB%93/">
        小结
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_9" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../chapter8/">第八章 异步编程</a>
<label for="__nav_9">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_9_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_9">
<span class="md-nav__icon md-icon"></span>
          第八章 异步编程
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter8/%E7%90%86%E8%A7%A3%E9%98%BB%E5%A1%9E%E9%9D%9E%E9%98%BB%E5%A1%9E%E5%92%8C%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C/">
        理解阻塞非阻塞和异步操作
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter8/%E7%90%86%E8%A7%A3%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/">
        理解事件循环
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter8/%E4%BD%BF%E7%94%A8asyncio/">
        使用asyncio
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../chapter8/%E6%80%BB%E7%BB%93/">
        小结
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目录
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_1">
    完整示例
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="celery">使用 Celery 获取斐波那契数列项</h1>
<p>让我们再次去分配我们的多个输入，以计算第 <code>n</code> 个斐波那契项，每个项都以分布式方式计算。 计算 <code>Fibonacci</code> 的函数相对于前面的章节会有一些变化。 变化很小； 现在我们有了 <code>@app.task</code> 装饰器和返回消息中的一个小改动。</p>
<p>在代理所在的服务器计算机中的 <code>tasks.py</code> 模块（之前创建）中，我们将停止执行 <code>Celery（Ctrl + C</code>）并添加 <code>fibo_task</code> 任务。 这是通过使用以下代码完成的：</p>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">fibo_task</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s2">"The Fibonacci calculated with task id </span><span class="si">%s</span><span class="s2"> was </span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">fibo_task</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</code></pre></div>
<p>通过<code>ask.reaquest.id</code>得到任务的ID，请求对象是<code>task</code>的对象，<code>task</code>对象提供了<code>task</code>执行的上下文。通过上下文可以得到<code>task</code>的ID等信息。</p>
<p>在<code>tasks.py</code>模块加入了新的任务之后，再一次初始化<strong>Celery</strong>，结果如下图：</p>
<div class="highlight"><pre><span></span><code>- *** --- * --- .&gt; concurrency: 2 (prefork)
-- ******* ---- .&gt; task events: OFF (enable -E to monitor tasks in this worker)
--- ***** -----
 -------------- [queues]
                .&gt; celery           exchange=celery(direct) key=celery


[tasks]
  . tasks.fibo_task
  . tasks.sqrt_task

[2023-03-06 17:05:34,402: INFO/MainProcess] Connected to redis://localhost:6379/0
</code></pre></div>
<p>现在我们把<code>fibo_task</code>任务装载到<strong>Celery server</strong>，我们将在客户端实现对该任务的调用。</p>
<p>在<code>task_dispatcher.py</code>模块，我们会申明<code>input_list</code>，如下：</p>
<div class="highlight"><pre><span></span><code><span class="n">input_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
</code></pre></div>
<p>和前面的做法一样，定义<code>manage_fibo_task</code>方法：</p>
<p>正如我们在上一节创建的 <code>sqrt_task</code> 任务中所做的那样，我们将创建一个方法来组织我们的调用而不污染 <code>__main__</code> 块。 我们将此函数命名为 <code>manage_fibo_task</code>。 如以下实现：</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">manage_fibo_task</span><span class="p">(</span><span class="n">value_list</span><span class="p">):</span>
    <span class="n">async_result_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">app</span><span class="o">.</span><span class="n">send_task</span><span class="p">(</span><span class="s1">'tasks.fibo_task'</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value_list</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">async_result_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Value [</span><span class="si">%d</span><span class="s2">] -&gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
</code></pre></div>
<p>在 <code>manage_fibo_task</code> 函数中，我们创建了一个名为 <code>async_result_dict</code> 的字典，填充相同的键值对。 <code>key</code> 是作为参数传递的项，用于获取 <code>Fibonacci</code> 的无数项，<code>value</code> 是从调用 <code>send_task</code> 方法返回的 <code>AsyncResult</code> 的实例。 通过这种方法，我们可以监控任务的状态和结果。</p>
<p>最后，遍历字典得到输入值和输出结果并封装成字典。<code>AsyncResult</code>类的<code>get()</code>函数可以让我们获取处理结果。</p>
<p><code>get()</code>方法会阻塞进程。一个好的方法是调用<code>ready()</code>方法来检查结果是否返回了。</p>
<p>可能会注意到 <code>get()</code> 函数可能不会立即返回结果，因为处理仍在进行。 在客户端调用 <code>get()</code> 方法可以阻止调用之后的处理。 将调用结合到 <code>ready()</code> 方法是个好主意，这样可以检查是否准备好获取结果。</p>
<p>因此，结果展示循环可以修改为如下代码:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">async_result_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Value [</span><span class="si">%d</span><span class="s2">] -&gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Task [</span><span class="si">%s</span><span class="s2">] is not ready"</span> <span class="o">%</span> <span class="n">value</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>
</code></pre></div>
<p>Depending on the type of task to be executed, there may be a considerable delay in the result. Therefore, by calling get() without considering the return status, we can block the code running at the point where the get() function was called. To tackle this, we should define an argument called timeout in the get(timeout=x) method. So, by minimizing this blocking, we can prevent tasks from having problems in returning results, which would impact the running of the execution for an indefinite time.</p>
<p>根据要执行的任务类型，结果可能会有相当长的延迟。 因此，通过调用 <code>get()</code> 而不考虑返回状态，我们可以阻止代码运行在 <code>get()</code> 函数被调用的地方。 为了解决这个问题，我们应该在 <code>get(timeout=x)</code> 方法中定义一个名为 <code>timeout</code> 的参数。 因此，通过最小化这种阻塞，我们可以防止任务在返回结果时出现问题，这会无限期地影响执行的运行。</p>
<p>最后，我们添加了对 <code>manage_fibo_task</code> 函数的调用，作为参数传递给我们的 <code>input_list</code>。 代码如下：</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="c1">#manage_sqrt_task(4)</span>
    <span class="n">manage_fibo_task</span><span class="p">(</span><span class="n">input_list</span><span class="p">)</span>
</code></pre></div>
<p>当我们执行<code>task_dispatcher.py</code>中的代码时，可以在旁边看到如下输出服务器：</p>
<div class="highlight"><pre><span></span><code><span class="nv">$#</span><span class="w"> </span>python<span class="w"> </span>task_dispatcher.py
<span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,902<span class="w"> </span>-<span class="w"> </span>Value<span class="w"> </span><span class="o">[</span><span class="m">4</span><span class="o">]</span><span class="w"> </span>-&gt;<span class="w"> </span>The<span class="w"> </span>Fibonacci<span class="w"> </span>calculated<span class="w"> </span>with<span class="w"> </span>task<span class="w"> </span>id<span class="w"> </span>03328f4d-8226-4a15-853d-8b8ab5833b72<span class="w"> </span>was<span class="w"> </span><span class="m">3</span>
<span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,904<span class="w"> </span>-<span class="w"> </span>Value<span class="w"> </span><span class="o">[</span><span class="m">3</span><span class="o">]</span><span class="w"> </span>-&gt;<span class="w"> </span>The<span class="w"> </span>Fibonacci<span class="w"> </span>calculated<span class="w"> </span>with<span class="w"> </span>task<span class="w"> </span>id<span class="w"> </span>4ea527de-0a96-4c6c-ac25-8e4a01a0e919<span class="w"> </span>was<span class="w"> </span><span class="m">2</span>
<span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,906<span class="w"> </span>-<span class="w"> </span>Task<span class="w"> </span><span class="o">[</span>448d8127-763c-4025-84a1-e05e9979841a<span class="o">]</span><span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>ready
<span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,909<span class="w"> </span>-<span class="w"> </span>Task<span class="w"> </span><span class="o">[</span>f639a24f-cbf5-403d-b243-4c5c54f5b77a<span class="o">]</span><span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>ready
<span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,909<span class="w"> </span>-<span class="w"> </span>Task<span class="w"> </span><span class="o">[</span>4e2999a7-bae8-454c-9f70-8b513dd0844e<span class="o">]</span><span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>ready
</code></pre></div>
<p>在客户端有如下输出：</p>
<div class="highlight"><pre><span></span><code>--<span class="w"> </span>*******<span class="w"> </span>----<span class="w"> </span>.&gt;<span class="w"> </span>task<span class="w"> </span>events:<span class="w"> </span>OFF<span class="w"> </span><span class="o">(</span><span class="nb">enable</span><span class="w"> </span>-E<span class="w"> </span>to<span class="w"> </span>monitor<span class="w"> </span>tasks<span class="w"> </span><span class="k">in</span><span class="w"> </span>this<span class="w"> </span>worker<span class="o">)</span>
---<span class="w"> </span>*****<span class="w"> </span>-----
<span class="w"> </span>--------------<span class="w"> </span><span class="o">[</span>queues<span class="o">]</span>
<span class="w">                </span>.&gt;<span class="w"> </span>celery<span class="w">           </span><span class="nv">exchange</span><span class="o">=</span>celery<span class="o">(</span>direct<span class="o">)</span><span class="w"> </span><span class="nv">key</span><span class="o">=</span>celery


<span class="o">[</span>tasks<span class="o">]</span>
<span class="w">  </span>.<span class="w"> </span>tasks.fibo_task
<span class="w">  </span>.<span class="w"> </span>tasks.sqrt_task

<span class="o">[</span><span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:35,572:<span class="w"> </span>INFO/MainProcess<span class="o">]</span><span class="w"> </span>Connected<span class="w"> </span>to<span class="w"> </span>redis://localhost:6379/0
<span class="o">[</span><span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:35,578:<span class="w"> </span>INFO/MainProcess<span class="o">]</span><span class="w"> </span>mingle:<span class="w"> </span>searching<span class="w"> </span><span class="k">for</span><span class="w"> </span>neighbors
<span class="o">[</span><span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:36,599:<span class="w"> </span>INFO/MainProcess<span class="o">]</span><span class="w"> </span>mingle:<span class="w"> </span>all<span class="w"> </span>alone
<span class="o">[</span><span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:36,616:<span class="w"> </span>INFO/MainProcess<span class="o">]</span><span class="w"> </span>celery@ch1.nauu.com<span class="w"> </span>ready.
<span class="o">[</span><span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,859:<span class="w"> </span>INFO/MainProcess<span class="o">]</span><span class="w"> </span>Task<span class="w"> </span>tasks.fibo_task<span class="o">[</span>03328f4d-8226-4a15-853d-8b8ab5833b72<span class="o">]</span><span class="w"> </span>received
<span class="o">[</span><span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,877:<span class="w"> </span>INFO/MainProcess<span class="o">]</span><span class="w"> </span>Task<span class="w"> </span>tasks.fibo_task<span class="o">[</span>4ea527de-0a96-4c6c-ac25-8e4a01a0e919<span class="o">]</span><span class="w"> </span>received
<span class="o">[</span><span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,884:<span class="w"> </span>INFO/MainProcess<span class="o">]</span><span class="w"> </span>Task<span class="w"> </span>tasks.fibo_task<span class="o">[</span>448d8127-763c-4025-84a1-e05e9979841a<span class="o">]</span><span class="w"> </span>received
<span class="o">[</span><span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,890:<span class="w"> </span>INFO/MainProcess<span class="o">]</span><span class="w"> </span>Task<span class="w"> </span>tasks.fibo_task<span class="o">[</span>f639a24f-cbf5-403d-b243-4c5c54f5b77a<span class="o">]</span><span class="w"> </span>received
<span class="o">[</span><span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,896:<span class="w"> </span>INFO/MainProcess<span class="o">]</span><span class="w"> </span>Task<span class="w"> </span>tasks.fibo_task<span class="o">[</span>4e2999a7-bae8-454c-9f70-8b513dd0844e<span class="o">]</span><span class="w"> </span>received
<span class="o">[</span><span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,898:<span class="w"> </span>INFO/ForkPoolWorker-2<span class="o">]</span><span class="w"> </span>Task<span class="w"> </span>tasks.fibo_task<span class="o">[</span>03328f4d-8226-4a15-853d-8b8ab5833b72<span class="o">]</span><span class="w"> </span>succeeded<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.03570139221847057s:<span class="w"> </span><span class="o">(</span><span class="m">4</span>,<span class="w"> </span><span class="s1">'The Fibonacci calculated with task id 03328f4d-8226-4a15-853d-8b8ab5833b72 was 3'</span><span class="o">)</span>
<span class="o">[</span><span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,903:<span class="w"> </span>INFO/ForkPoolWorker-1<span class="o">]</span><span class="w"> </span>Task<span class="w"> </span>tasks.fibo_task<span class="o">[</span>4ea527de-0a96-4c6c-ac25-8e4a01a0e919<span class="o">]</span><span class="w"> </span>succeeded<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.02462736703455448s:<span class="w"> </span><span class="o">(</span><span class="m">3</span>,<span class="w"> </span><span class="s1">'The Fibonacci calculated with task id 4ea527de-0a96-4c6c-ac25-8e4a01a0e919 was 2'</span><span class="o">)</span>
<span class="o">[</span><span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,920:<span class="w"> </span>INFO/ForkPoolWorker-2<span class="o">]</span><span class="w"> </span>Task<span class="w"> </span>tasks.fibo_task<span class="o">[</span>448d8127-763c-4025-84a1-e05e9979841a<span class="o">]</span><span class="w"> </span>succeeded<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.014719393104314804s:<span class="w"> </span><span class="o">(</span><span class="m">8</span>,<span class="w"> </span><span class="s1">'The Fibonacci calculated with task id 448d8127-763c-4025-84a1-e05e9979841a was 21'</span><span class="o">)</span>
<span class="o">[</span><span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,928:<span class="w"> </span>INFO/ForkPoolWorker-2<span class="o">]</span><span class="w"> </span>Task<span class="w"> </span>tasks.fibo_task<span class="o">[</span>4e2999a7-bae8-454c-9f70-8b513dd0844e<span class="o">]</span><span class="w"> </span>succeeded<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.0018890555948019028s:<span class="w"> </span><span class="o">(</span><span class="m">10</span>,<span class="w"> </span><span class="s1">'The Fibonacci calculated with task id 4e2999a7-bae8-454c-9f70-8b513dd0844e was 55'</span><span class="o">)</span>
<span class="o">[</span><span class="m">2023</span>-03-06<span class="w"> </span><span class="m">17</span>:20:38,931:<span class="w"> </span>INFO/ForkPoolWorker-1<span class="o">]</span><span class="w"> </span>Task<span class="w"> </span>tasks.fibo_task<span class="o">[</span>f639a24f-cbf5-403d-b243-4c5c54f5b77a<span class="o">]</span><span class="w"> </span>succeeded<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.012269522994756699s:<span class="w"> </span><span class="o">(</span><span class="m">6</span>,<span class="w"> </span><span class="s1">'The Fibonacci calculated with task id f639a24f-cbf5-403d-b243-4c5c54f5b77a was 8'</span><span class="o">)</span>
</code></pre></div>
<h2 id="_1">完整示例</h2>
<p><code>tasks.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">'tasks'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s1">'redis://localhost/0'</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">'redis://localhost/0'</span><span class="p">)</span>
<span class="c1"># app.config.CELERY_RESULT_BACKEND = 'redis://192.168.99.89:6379/0'</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">sqrt_task</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span> <span class="nf">fibo_task</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s2">"The Fibonacci calculated with task id </span><span class="si">%s</span><span class="s2"> was </span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">fibo_task</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</code></pre></div>
<p><code>tasks_dispatcher.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span> <span class="nn">celery.result</span> <span class="kn">import</span> <span class="n">AsyncResult</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">'</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">'</span><span class="p">)</span>

<span class="n">ch</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">'tasks'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s1">'redis://localhost/0'</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s1">'redis://localhost/0'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">manage_sqrt_task</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">send_task</span><span class="p">(</span><span class="s1">'tasks.sqrt_task'</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">value</span><span class="p">,))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>



<span class="k">def</span> <span class="nf">manage_fibo_task</span><span class="p">(</span><span class="n">value_list</span><span class="p">):</span>
    <span class="n">async_result_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">AsyncResult</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">app</span><span class="o">.</span><span class="n">send_task</span><span class="p">(</span><span class="s1">'tasks.fibo_task'</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value_list</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">async_result_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Value [</span><span class="si">%d</span><span class="s2">] -&gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Task [</span><span class="si">%s</span><span class="s2">] is not ready"</span> <span class="o">%</span> <span class="n">value</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">input_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
    <span class="c1"># print(manage_sqrt_task(4))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">manage_fibo_task</span><span class="p">(</span><span class="n">input_list</span><span class="p">))</span>
</code></pre></div>
<hr/>
<div class="md-source-file">
<small>
    
      最后更新:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2023年3月6日</span>
<br/>
        创建日期:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2023年3月6日</span>
</small>
</div>
</article>
</div>
</div>
<a class="md-top md-icon" data-md-component="top" hidden="" href="#">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg>
            回到页面顶部
          </a>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.indexes", "navigation.top", "toc.follow"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../../assets/javascripts/bundle.2a6f1dda.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
<script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>